<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Saveior | Budgets</title>
		<link
			rel="icon"
			href="https://raw.githubusercontent.com/Zetcor/Saveior/main/boink.png"
			type="image/x-icon"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<script
			src="https://kit.fontawesome.com/203f7bcb2a.js"
			crossorigin="anonymous"
		></script>
		<link rel="stylesheet" href="styles.css" />
		<link rel="stylesheet" href="budget.css" />
	</head>
	<body>
		<div class="rounded-container">
			<!-- Navbar -->
			<nav class="navbar navbar-expand-lg container-fluid sticky-top">
				<div class="navbar-container">
					<a class="nav-logo text-decoration-none fs-4" href="index.html">
						<img
							src="https://raw.githubusercontent.com/Zetcor/Saveior/main/boink.png"
							alt="Logo"
						/>
						Saveior
					</a>
				</div>

				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent"
					aria-controls="navbarSupportedContent"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>

				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<div
						class="collapse navbar-collapse justify-content-center"
						id="navbarSupportedContent"
					>
						<ul
							class="nav flex-lg-row flex-column text-center gap-3 navbar-container"
						>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="dashboard.html"
									>Dashboard</a
								>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="index.html"
									>Records</a
								>
							</li>
							<li class="nav-item">
								<a class="nav-link px-4 active" href="budgets.html"
									>Budgets</a
								>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="accounts.html"
									>Accounts</a
								>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="#">Categories</a>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="savings.html"
									>Savings</a
								>
							</li>
						</ul>
					</div>
					<div class="ms-lg-auto mt-2 mt-lg-0">
						<div
							class="d-flex flex-column flex-lg-row justify-content-center justify-content-lg-end text-center"
						>
							<button class="icon-btn d-none d-lg-flex">
								<i class="fa-solid fa-gear"></i>
							</button>
							<button class="icon-btn d-none d-lg-flex">
								<i class="fa-solid fa-user"></i>
							</button>
						</div>
					</div>
				</div>
			</nav>

			<!-- Summary -->
			<div class="tracker-container summary-container mt-3">
				<div class="summary p-3 mb-3 d-flex justify-content-around flex-wrap text-center">
					<div class="text-dark">
						TOTAL BUDGET:
						<span id="total-budget" class="text-success">₱0</span>
					</div>
					<div class="text-dark">
						TOTAL SPENT:
						<span id="total-spent" class="text-danger">₱0</span>
					</div>
					<div class="text-dark">
						REMAINING:
						<span id="total-remaining" class="text-primary">₱0</span>
					</div>
				</div>
			</div>

			<!-- Budget Categories -->
			<div class="tracker-container mt-4">
				<div class="calculator-container" style="flex: 1 1 100%">
					<h4 class="fw-bold mb-3">Budgets</h4>

					<div id="budgetList" class="row g-3"></div>
				</div>
			</div>
		</div>

		<!-- Edit Budget Modal -->
		<div class="modal fade" id="budgetModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<form id="budgetForm" class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Set Budget Limit</h5>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"
						></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<label class="form-label">Category</label>
							<input
								type="text"
								class="form-control"
								id="budgetCategory"
								readonly
							/>
						</div>
						<div class="mb-3">
							<label class="form-label">Budget Limit (₱)</label>
							<input
								type="number"
								min="0"
								step="0.01"
								class="form-control"
								id="budgetAmount"
								required
							/>
						</div>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-danger"
							id="resetBudgetBtn"
						>
							<i class="bi bi-arrow-counterclockwise"></i> Reset
						</button>
						<button
							type="button"
							class="btn btn-light"
							data-bs-dismiss="modal"
						>
							Cancel
						</button>
						<button class="btn btn-success" type="submit">
							<i class="bi bi-check2-circle"></i> Save
						</button>
					</div>
				</form>
			</div>
		</div>

		<script>
			const ACCOUNTS_KEY = "saveior.accounts";
			const BUDGETS_KEY = "saveior.budgets";
			const TRANSACTIONS_KEY = "saveior.transactions";
			const CATEGORIES = ["Food", "Transportation", "Bills", "Tax", "Shopping"];

			let budgets = JSON.parse(localStorage.getItem(BUDGETS_KEY) || "{}");

			function getTransactions() {
				return JSON.parse(localStorage.getItem(TRANSACTIONS_KEY) || "[]");
			}

			function getTotalAccountsBalance() {
				const accounts = JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || "[]");
				let total = 0;
				accounts.forEach(acc => {
					total += Number(acc.balance || 0);
				});
				return total;
			}

			function calculateSpentByCategory() {
				const transactions = getTransactions();
				const spent = {};
				CATEGORIES.forEach((c) => (spent[c] = 0));

				transactions.forEach((tx) => {
					const category = tx.category || "";
					if (CATEGORIES.includes(category) && tx.type === "expense") {
						spent[category] += Number(tx.amount || 0);
					}
				});
				return spent;
			}

			function renderBudgets() {
				const list = document.getElementById("budgetList");
				list.innerHTML = "";

				const spent = calculateSpentByCategory();

				let totalBudget = 0;
				let totalSpent = 0;

			CATEGORIES.forEach((category) => {
				const limit = Number(budgets[category] || 0);
				const used = Number(spent[category] || 0);
				const remaining = limit - used;

				totalBudget += limit;
				totalSpent += used;

				const remainingClass = remaining < 0 ? "text-danger fw-bold" : "text-primary";

				// calculate percentage of limit used
				const pct = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
				const progressColor =
					pct >= 90 ? "bg-danger" : pct >= 70 ? "bg-warning" : "bg-success";

				const col = document.createElement("div");
				col.className = "col-12 col-md-6 col-lg-4";

				col.innerHTML = `
					<div class="goal-card p-3" style="cursor:pointer;" onclick="openEditBudget('${category}')">
						<div class="d-flex justify-content-between align-items-center">
							<h5 class="fw-bold mb-0">${category}</h5>
						</div>
						<hr>

						<!-- Two-column stats layout -->
						<div class="stats-2col mb-3">
							<div class="stat-label">Spent</div>
							<div class="stat-val text-danger">₱${used.toLocaleString()}</div>
							<div class="stat-label">Remaining</div>
							<div class="stat-val ${remainingClass}">₱${remaining.toLocaleString()}</div>
						</div>

						<!-- Progress bar -->
						<div class="progress mb-2" style="height: 10px;">
							<div class="progress-bar ${progressColor}"
								role="progressbar"
								style="width: ${pct}%;"
								aria-valuenow="${pct}"
								aria-valuemin="0"
								aria-valuemax="100"></div>
						</div>

						<!-- Limit and percentage summary below progress -->
						<div class="d-flex justify-content-between small text-muted">
							<span>${pct.toFixed(1)}% used</span>
							<span>Limit: ₱${limit.toLocaleString()}</span>
						</div>
					</div>
				`;

				list.appendChild(col);
			});



				document.getElementById("total-budget").textContent =
					"₱" + totalBudget.toLocaleString();
				document.getElementById("total-spent").textContent =
					"₱" + totalSpent.toLocaleString();
				document.getElementById("total-remaining").textContent =
					"₱" + (totalBudget - totalSpent).toLocaleString();
			}

			function openEditBudget(category) {
				document.getElementById("budgetCategory").value = category;
				document.getElementById("budgetAmount").value = budgets[category] || 0;
				const modal = new bootstrap.Modal(document.getElementById("budgetModal"));
				modal.show();
			}

			document
				.getElementById("budgetForm")
				.addEventListener("submit", function (e) {
					e.preventDefault();
					const category = document.getElementById("budgetCategory").value;
					const amount = parseFloat(
						document.getElementById("budgetAmount").value
					);

					const totalFunds = getTotalAccountsBalance();

					let currentTotalBudget = 0;
					for (const [cat, val] of Object.entries(budgets)) {
						if (cat !== category) currentTotalBudget += Number(val || 0);
					}

					if (currentTotalBudget + amount > totalFunds) {
						alert("Your total budgets cannot exceed your total available funds (₱" + totalFunds.toLocaleString() + ").");
						return;
					}

					// Save valid budget
					budgets[category] = amount;
					localStorage.setItem(BUDGETS_KEY, JSON.stringify(budgets));
					renderBudgets();

					const modal = bootstrap.Modal.getInstance(document.getElementById("budgetModal"));
					modal.hide();

					if (!isNaN(amount) && amount >= 0) {
						budgets[category] = amount;
						localStorage.setItem(BUDGETS_KEY, JSON.stringify(budgets));
						renderBudgets();
						bootstrap.Modal.getInstance(
							document.getElementById("budgetModal")
						).hide();
					}
				});

				document.getElementById("resetBudgetBtn").addEventListener("click", () => {
					const category = document.getElementById("budgetCategory").value;

					if (!category) return;

					if (confirm(`Are you sure you want to reset the budget for ${category}?`)) {
						budgets[category] = 0;
						localStorage.setItem(BUDGETS_KEY, JSON.stringify(budgets));
						renderBudgets();

						const modal = bootstrap.Modal.getInstance(document.getElementById("budgetModal"));
						modal.hide();
					}
				});

			window.addEventListener("storage", (e) => {
				if (e.key === TRANSACTIONS_KEY || e.key === BUDGETS_KEY) {
					budgets = JSON.parse(localStorage.getItem(BUDGETS_KEY) || "{}");
					renderBudgets();
				}
			});

			window.addEventListener("focus", renderBudgets);
			document.addEventListener("DOMContentLoaded", renderBudgets);
		</script>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
	</body>
</html>
