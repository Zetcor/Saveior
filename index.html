<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Saveior | Record</title>
		<link
			rel="icon"
			href="https://raw.githubusercontent.com/Zetcor/Saveior/main/boink.png"
			type="image/x-icon"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
			crossorigin="anonymous"
		/>
		<script
			src="https://kit.fontawesome.com/203f7bcb2a.js"
			crossorigin="anonymous"
		></script>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body>
		<div class="rounded-container">
			<nav class="navbar navbar-expand-lg container-fluid sticky-top">
				<div class="navbar-container">
					<a class="nav-logo text-decoration-none fs-4" href="index.html">
						<img
							src="https://raw.githubusercontent.com/Zetcor/Saveior/main/boink.png"
							alt="Logo"
						/>
						Saveior
					</a>
				</div>

				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent"
					aria-controls="navbarSupportedContent"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>

				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<div
						class="collapse navbar-collapse justify-content-center"
						id="navbarSupportedContent"
					>
						<ul
							class="nav flex-lg-row flex-column text-center gap-3 navbar-container"
						>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="dashboard.html">Dashboard</a>
							</li>
							<li class="nav-item">
								<a class="nav-link px-4 active" href="#">Records</a>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="#">Budgets</a>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="accounts.html"
									>Accounts</a
								>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="#">Categories</a>
							</li>
							<li class="nav-item">
								<a class="nav-link text-light px-4" href="savings.html"
									>Savings</a
								>
							</li>
							<a href="#" class="nav-link d-lg-none">Settings</a>
							<a href="#" class="nav-link d-lg-none">Accounts</a>
						</ul>
					</div>

					<div class="ms-lg-auto mt-2 mt-lg-0">
						<div
							class="d-flex flex-column flex-lg-row justify-content-center justify-content-lg-end text-center"
						>
							<button class="icon-btn d-none d-lg-flex">
								<i class="fa-solid fa-gear"></i>
							</button>
							<button class="icon-btn d-none d-lg-flex">
								<i class="fa-solid fa-user"></i>
							</button>
						</div>
					</div>
				</div>
			</nav>

			<div
				class="button-container position-absolute start-50 translate-middle-x mt-5"
			>
				<input
					type="radio"
					id="expense"
					name="transactionType"
					value="expense"
					checked
				/>
				<label for="expense">Expense</label>

				<input type="radio" id="income" name="transactionType" value="income" />
				<label for="income">Income</label>

				<input
					type="radio"
					id="transfer"
					name="transactionType"
					value="transfer"
				/>
				<label for="transfer">Transfer</label>
			</div>

			<div class="tracker-container">
				<div class="calculator-container">
					<div class="tabs d-flex gap-2 mb-2">
						<select
							id="accountDropdown"
							class="form-select custom-dropdown"
						></select>
						<select
							id="categoryDropdown"
							class="form-select custom-dropdown"
						></select>
					</div>

					<textarea
						id="desc-input"
						class="notes mt-3"
						placeholder="Add notes"
					></textarea>

					<input
						type="text"
						id="display"
						class="form-control calc-display mt-3"
						disabled
					/>

					<div class="row g-2 mt-1">
						<div class="col-6">
							<button
								class="btn btn-light border calc-btn w-100"
								onclick="clearDisplay()"
							>
								C
							</button>
						</div>
						<div class="col-6">
							<button
								class="btn btn-light border calc-btn w-100"
								onclick="deleteLast()"
							>
								⌫
							</button>
						</div>
					</div>

					<div class="row g-2 my-2">
						<div class="col-3">
							<button
								class="btn btn-light border calc-btn w-100"
								onclick="press('+')"
							>
								+
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('7')">
								7
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('8')">
								8
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('9')">
								9
							</button>
						</div>

						<div class="col-3">
							<button
								class="btn btn-light border calc-btn w-100"
								onclick="press('-')"
							>
								−
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('4')">
								4
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('5')">
								5
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('6')">
								6
							</button>
						</div>

						<div class="col-3">
							<button
								class="btn btn-light border calc-btn w-100"
								onclick="press('*')"
							>
								×
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('1')">
								1
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('2')">
								2
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('3')">
								3
							</button>
						</div>

						<div class="col-3">
							<button
								class="btn btn-light border calc-btn w-100"
								onclick="press('/')"
							>
								÷
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('0')">
								0
							</button>
						</div>
						<div class="col-3">
							<button class="text-darkteal calc-btn w-100" onclick="press('.')">
								.
							</button>
						</div>
						<div class="col-3">
							<button
								class="btn btn-light border calc-btn w-100"
								onclick="calculateResult()"
							>
								=
							</button>
						</div>
					</div>

					<div class="save-cancel">
						<button class="btn btn-danger" onclick="cancelEntry()">Back</button>
						<button class="btn btn-success" onclick="saveEntry()">Save</button>
					</div>
				</div>

				<div class="summary-container ms-5">
					<div class="summary p-3 mb-3 d-flex justify-content-around">
						<div class="text-dark">
							EXPENSE: <span id="total-expenses" class="text-danger">₱0</span>
						</div>
						<div class="text-dark">
							INCOME: <span id="total-income" class="text-success">₱0</span>
						</div>
					</div>

					<div class="entries" id="expense-list"></div>

					<div class="total-bar text-center">
						TOTAL: <span id="balance" class="text-gold">₱0</span>
					</div>
				</div>
			</div>
		</div>

		<script>
			let totalIncome = 0;
			let totalExpenses = 0;
			let currentAmount = null;

			const ACCOUNTS_KEY = 'saveior.accounts';
			const TRANSACTIONS_KEY = 'saveior.transactions';

			function ensureAccountDefaults() {
				const current = JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '[]');
				if (current.length > 0) return;

				const defaults = [
					{ id: crypto.randomUUID(), name: 'Cash', balance: 0 },
					{ id: crypto.randomUUID(), name: 'Credit Card', balance: 0 },
					{ id: crypto.randomUUID(), name: 'Debit Card', balance: 0 },
				];
				localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(defaults));
			}

			function getStoredAccounts() {
				ensureAccountDefaults();
				return JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '[]');
			}

			function updateAccountBalanceByName(accountName, amountChange) {
				const data = getStoredAccounts();
				const idx = data.findIndex((a) => a.name === accountName);
				if (idx >= 0) {
					data[idx].balance =
						(Number(data[idx].balance) || 0) + Number(amountChange);
					localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(data));
				}
			}

			function getStoredTransactions() {
				return JSON.parse(localStorage.getItem(TRANSACTIONS_KEY) || '[]');
			}

			function saveStoredTransactions(transactions) {
				localStorage.setItem(TRANSACTIONS_KEY, JSON.stringify(transactions));
			}

			function addTransactionToStorage(entryData) {
				const transactions = getStoredTransactions();
				transactions.push(entryData);
				saveStoredTransactions(transactions);
			}

			function deleteTransactionFromStorage(index) {
				const transactions = getStoredTransactions();
				transactions.splice(index, 1);
				saveStoredTransactions(transactions);
			}

			function resetAccountOptions(type) {
				const accountDropdown = document.getElementById('accountDropdown');
				accountDropdown.innerHTML = '';

				const ACCOUNTS_KEY = 'saveior.accounts';
				function getStoredAccounts() {
					const data = localStorage.getItem(ACCOUNTS_KEY);
					return data ? JSON.parse(data) : [];
				}

				const accounts = getStoredAccounts();
				const placeholder = type === 'transfer' ? 'From Account' : 'Account';

				const defaultOption = document.createElement('option');
				defaultOption.textContent = placeholder;
				defaultOption.disabled = true;
				defaultOption.selected = true;
				accountDropdown.appendChild(defaultOption);

				accounts.forEach((acc) => {
					const optionElement = document.createElement('option');
					optionElement.value = acc.name || '';
					optionElement.textContent = acc.name || '';
					accountDropdown.appendChild(optionElement);
				});
			}

			function updateCategoryOptions(type) {
				const categoryDropdown = document.getElementById('categoryDropdown');
				categoryDropdown.innerHTML = '';

				let options = [];

				if (type === 'income') {
					options = ['Salary', 'Allowance', 'Part-Time', 'Investment', 'Bonus'];
				} else if (type === 'expense') {
					options = ['Food', 'Transportation', 'Bills', 'Tax', 'Shopping'];
				} else if (type === 'transfer') {
					const ACCOUNTS_KEY = 'saveior.accounts';
					const accounts = JSON.parse(
						localStorage.getItem(ACCOUNTS_KEY) || '[]'
					);
					options = accounts.map((a) => a.name);
				}

				const defaultOption = document.createElement('option');
				defaultOption.textContent =
					type === 'transfer' ? 'To Account' : 'Category';
				defaultOption.disabled = true;
				defaultOption.selected = true;
				categoryDropdown.appendChild(defaultOption);

				options.forEach((opt) => {
					const optionElement = document.createElement('option');
					optionElement.value = opt;
					optionElement.textContent = opt;
					categoryDropdown.appendChild(optionElement);
				});
			}

			function handleDropdownColor(id) {
				const dropdown = document.getElementById(id);
				if (!dropdown) return;
				dropdown.addEventListener('change', function () {
					const defaults = [
						'Account',
						'From Account',
						'Category',
						'To Account',
					];
					if (defaults.includes(this.options[this.selectedIndex].text))
						this.classList.remove('active');
					else this.classList.add('active');
				});
			}

			function press(val) {
				document.getElementById('display').value += val;
				liveCalculate();
			}
			function clearDisplay() {
				document.getElementById('display').value = '';
				currentAmount = null;
			}
			function liveCalculate() {
				try {
					let expr = document
						.getElementById('display')
						.value.replace(/×/g, '*')
						.replace(/÷/g, '/');
					if (!expr.trim()) return;
					let result = eval(expr);
					if (!isNaN(result)) currentAmount = parseFloat(result);
				} catch {
					currentAmount = null;
				}
			}
			function calculateResult() {
				try {
					let expr = document
						.getElementById('display')
						.value.replace(/×/g, '*')
						.replace(/÷/g, '/');
					let result = eval(expr);
					if (!isNaN(result)) {
						document.getElementById('display').value = result;
						currentAmount = parseFloat(result);
					}
				} catch {
					alert('Invalid calculation!');
					currentAmount = null;
				}
			}
			function deleteLast() {
				let d = document.getElementById('display');
				d.value = d.value.slice(0, -1);
				liveCalculate();
			}

			document.addEventListener('keydown', (e) => {
				if (document.activeElement.id === 'desc-input') return;
				const key = e.key;
				if (!isNaN(key) || '+-*/.'.includes(key)) press(key);
				else if (key === 'Enter') {
					e.preventDefault();
					calculateResult();
				} else if (key === 'Backspace') deleteLast();
				else if (key === 'Escape') clearDisplay();
			});

			function getCategoryIcon(category) {
				if (category === 'Food') return '<i class="fa-solid fa-utensils"></i>';
				if (category === 'Transportation')
					return '<i class="fa-solid fa-bus"></i>';
				if (category === 'Bills')
					return '<i class="fa-solid fa-file-invoice"></i>';
				if (category === 'Tax')
					return '<i class="fa-solid fa-money-bill-wave"></i>';
				if (category === 'Shopping')
					return '<i class="fa-solid fa-basket-shopping"></i>';
				if (category === 'Salary')
					return '<i class="fa-solid fa-sack-dollar"></i>';
				if (category === 'Allowance')
					return '<i class="fa-solid fa-coins"></i>';
				if (category === 'Part-Time')
					return '<i class="fa-solid fa-clock"></i>';
				if (category === 'Investment')
					return '<i class="fa-solid fa-chart-line"></i>';
				if (category === 'Bonus') return '<i class="fa-solid fa-gift"></i>';
				if (category === 'Cash')
					return '<i class="fa-solid fa-money-bill"></i>';
				if (category === 'Credit Card')
					return '<i class="fa-solid fa-credit-card"></i>';
				if (category === 'Debit Card')
					return '<i class="fa-solid fa-credit-card"></i>';
				return '<i class="fa-solid fa-credit-card"></i>';
			}

			function getAccountIcon(account) {
				if (account === 'Cash') return '<i class="fa-solid fa-money-bill"></i>';
				if (account === 'Credit Card')
					return '<i class="fa-solid fa-credit-card"></i>';
				if (account === 'Debit Card')
					return '<i class="fa-solid fa-credit-card"></i>';
				return '<i class="fa-solid fa-wallet"></i>';
			}

			function renderTransaction(entryData, index) {
				const list = document.getElementById('expense-list');
				const entry = document.createElement('div');
				entry.className = `entry-item ${entryData.type}`;
				entry.dataset.amount = entryData.amount;
				entry.dataset.type = entryData.type;
				entry.dataset.index = index;
				entry.dataset.account = entryData.account || '';

				
				// Store transfer endpoints for delete reversal
				if (entryData.type === 'transfer') {
					entry.dataset.from = entryData.from || '';
					entry.dataset.to = entryData.to || '';
				}
let htmlContent = '';

				if (entryData.type === 'transfer') {
					htmlContent = `
			<div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
				<div>
					<div><i class="fa-solid fa-right-left"></i> Transfer</div>
					<div style="color: gray; font-size: 12px;">From: ${entryData.from} → To: ${
						entryData.to
					}</div>
					<div style="color: gray; font-size: 12px; font-weight: 500">${
						entryData.desc || ''
					}</div>
				</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div>₱${Number(entryData.amount).toLocaleString('en-US', {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2,
					})}</div>
					<button class="btn btn-sm btn-outline-danger delete-btn"><i class="bi bi-trash3"></i></button>
				</div>
			</div>`;
				} else {
					htmlContent = `
			<div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
				<div>
					<div>${getCategoryIcon(entryData.category)} ${entryData.category}</div>
					<div style="color: gray; font-size: 12px;">${getAccountIcon(
						entryData.account
					)} ${entryData.account}</div>
					<div style="color: gray; font-size: 12px; font-weight: 500">${
						entryData.desc || ''
					}</div>
				</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div>₱${Number(entryData.amount).toLocaleString('en-US', {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2,
					})}</div>
					<button class="btn btn-sm btn-outline-danger delete-btn"><i class="bi bi-trash3"></i></button>
				</div>
			</div>`;
				}

				entry.innerHTML = htmlContent;
				list.prepend(entry);
				entry
					.querySelector('.delete-btn')
					.addEventListener('click', () => deleteEntry(entry));
			}

			function saveEntry() {
				let category = document.getElementById('categoryDropdown').value || '';
				let account = document.getElementById('accountDropdown').value || '';
				let desc = document.getElementById('desc-input').value.trim();
				let type =
					document.querySelector('input[name="transactionType"]:checked')
						?.value || null;

				if (!currentAmount || isNaN(currentAmount) || currentAmount <= 0) {
					alert('Enter a valid amount!');
					return;
				}

				if (type === 'transfer') {
					if (!account || !category) {
						alert('Please select both From Account and To Account!');
						return;
					}

					if (account === category) {
						alert('You cannot transfer to the same account!');
						return;
					}
				} else {
					if (!account) {
						alert('Please select an account!');
						return;
					}
					if (!category) {
						alert('Please select a category!');
						return;
					}
				}

				let entryData = {
					type,
					account,
					category,
					desc,
					amount: currentAmount,
					date: new Date().toISOString(),
				};

				if (type === 'transfer') {
					const from = document.getElementById('accountDropdown').value;
					const to = document.getElementById('categoryDropdown').value;
					if (!from || !to || from === to) {
						alert('Please select valid From and To accounts!');
						return;
					}

					updateAccountBalanceByName(from, -currentAmount);
					updateAccountBalanceByName(to, currentAmount);

					entryData.from = from;
					entryData.to = to;
					entryData.category = `Transfer: ${from} → ${to}`;
				} else if (type === 'income') {
					updateAccountBalanceByName(account, currentAmount);
					totalIncome += currentAmount;
				} else if (type === 'expense') {
					updateAccountBalanceByName(account, -currentAmount);
					totalExpenses += currentAmount;
				}

				addTransactionToStorage(entryData);
				renderTransaction(entryData);
				updateSummary();
				cancelEntry(type);
			}

			function validateTransferAccounts() {
				const fromAcc = document.getElementById('accountDropdown').value;
				const toAcc = document.getElementById('categoryDropdown').value;

				if (fromAcc === toAcc) {
					alert('You cannot transfer to the same account!');
					return false;
				}
				return true;
			}

			function deleteEntry(entry) {
				const idx = parseInt(entry.dataset.index);
				const amount = parseFloat(entry.dataset.amount || '0');
				const type = entry.dataset.type;
				const account = entry.dataset.account;

				const confirmDelete = confirm(
					'Are you sure you want to delete this transaction?'
				);
				if (!confirmDelete) return;

				if (type === 'income') {
					totalIncome -= amount;
					updateAccountBalanceByName(account, -amount);
				} else if (type === 'expense') {
					totalExpenses -= amount;
					updateAccountBalanceByName(account, amount);
				} else if (type === 'transfer') {
					updateAccountBalanceByName(entry.dataset.from, amount);
					updateAccountBalanceByName(entry.dataset.to, -amount);
				}

				deleteTransactionFromStorage(idx);
				entry.remove();
				updateSummary();
			}

			function cancelEntry(type) {
				document.getElementById('desc-input').value = '';
				document.getElementById('display').value = '';
				currentAmount = null;
				const t = type || 'expense';
				resetAccountOptions(t);
				updateCategoryOptions(t);
				document.getElementById('accountDropdown').classList.remove('active');
				document.getElementById('categoryDropdown').classList.remove('active');
			}

			function updateSummary() {
				document.getElementById('total-income').textContent =
					'₱' +
					totalIncome.toLocaleString('en-US', {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2,
					});
				document.getElementById('total-expenses').textContent =
					'₱' +
					totalExpenses.toLocaleString('en-US', {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2,
					});
				document.getElementById('balance').textContent =
					'₱' +
					(totalIncome - totalExpenses).toLocaleString('en-US', {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2,
					});
			}

			function setTypeUI(type) {
				const accDropdown = document.getElementById('accountDropdown');
				const categoryDropdown = document.getElementById('categoryDropdown');

				resetAccountOptions(type);
				updateCategoryOptions(type);

				if (type === 'transfer') {
					accDropdown.options[0].textContent = 'From Account';
					categoryDropdown.options[0].textContent = 'To Account';
				} else {
					accDropdown.options[0].textContent = 'Account';
					categoryDropdown.options[0].textContent = 'Category';
				}
			}

			document.addEventListener('DOMContentLoaded', function () {
				resetAccountOptions('expense');
				updateCategoryOptions('expense');
				handleDropdownColor('accountDropdown');
				handleDropdownColor('categoryDropdown');
				handleDropdownColor('transferFrom');
				handleDropdownColor('transferTo');

				const transactions = getStoredTransactions();
				document.getElementById('expense-list').innerHTML = '';

				transactions.forEach((t, index) => {
					renderTransaction(t, index);
					if (t.type === 'income') totalIncome += t.amount;
					else if (t.type === 'expense') totalExpenses += t.amount;
				});
				updateSummary();

				document
					.querySelectorAll('input[name="transactionType"]')
					.forEach((radio) => {
						radio.addEventListener('change', (e) => {
							setTypeUI(e.target.value);
							document.getElementById('desc-input').value = '';
							document.getElementById('display').value = '';
							currentAmount = null;
							document.querySelectorAll('.custom-dropdown').forEach((d) => {
								d.selectedIndex = 0;
								d.classList.remove('active');
							});
						});
					});

				setTypeUI(
					document.querySelector('input[name="transactionType"]:checked').value
				);
			});
		</script>

		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
			crossorigin="anonymous"
		></script>
	</body>
</html>
